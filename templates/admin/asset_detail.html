{% extends "admin/base.html" %}
{% block title %}{{ asset.name }} - {{ brand_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ asset.name }}</h1>
    <div class="d-flex gap-10">
        <a href="{{ url_for('admin.asset_edit', id=asset.id) }}" class="btn btn-outline">Bearbeiten</a>
        {% if not asset.disposal_date %}
        <a href="{{ url_for('admin.asset_dispose', id=asset.id) }}" class="btn btn-warning">Abgang erfassen</a>
        {% endif %}
        <a href="{{ url_for('invoicing.quote_new', asset_id=asset.id) }}" class="btn btn-outline">Angebot erstellen</a>
        <a href="{{ url_for('admin.assets') }}" class="btn btn-outline">‚Üê Zur√ºck</a>
    </div>
</div>

<!-- Status + Key Info -->
{% if asset.bundle_id %}
<div class="card" style="background: var(--bg-secondary); padding: 12px 16px; margin-bottom: 16px;">
    <strong>üì¶ B√ºndel-Anlagegut</strong>
    <span class="text-muted text-sm">‚Äî Dieses Anlagegut geh√∂rt zu einem B√ºndel
    ({{ bundle_count }} Stk.{% if bundle_active < bundle_count %}, {{ bundle_active }} aktiv{% endif %}).</span>
    <div class="mt-6 d-flex gap-10">
        <a href="{{ url_for('admin.bundle_edit', bundle_id=asset.bundle_id) }}" class="btn btn-sm btn-outline">Ganzes B√ºndel bearbeiten</a>
        {% if bundle_active > 0 %}
        <a href="{{ url_for('admin.bundle_dispose', bundle_id=asset.bundle_id) }}" class="btn btn-sm btn-outline">Teilabgang</a>
        {% endif %}
        <a href="{{ url_for('admin.assets') }}" class="text-accent text-sm" style="align-self: center;">Alle anzeigen</a>
    </div>
</div>
{% endif %}

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Anschaffungskosten (Netto)</div>
        <div class="stat-value">{{ asset.purchase_price_net|currency }}</div>
    </div>
    <div class="stat-card stat-success">
        <div class="stat-label">Aktueller Buchwert</div>
        <div class="stat-value">{{ book_value|currency }}</div>
    </div>
    <div class="stat-card {{ 'stat-danger' if asset.disposal_date else 'stat-muted' }}">
        <div class="stat-label">Status</div>
        <div class="stat-value text-sm" style="font-size: 1.2em;">
            {% if asset.disposal_date %}
                Abgegangen ({{ asset.disposal_date|date_format }})
            {% elif book_value <= (asset.salvage_value or 0) %}
                Vollst√§ndig abgeschrieben
            {% else %}
                Aktiv
            {% endif %}
        </div>
    </div>
</div>

<!-- Details Card -->
<div class="card">
    <div class="card-header">Stammdaten</div>
    <div class="form-row">
        <div>
            <div class="text-muted text-sm mb-4">Bezeichnung</div>
            <div class="font-semibold">{{ asset.name }}</div>
        </div>
        <div>
            <div class="text-muted text-sm mb-4">Beschreibung</div>
            <div>{{ asset.description or '‚Äì' }}</div>
        </div>
    </div>
    <hr class="section-divider">
    <div class="form-row">
        <div>
            <div class="text-muted text-sm mb-4">Anschaffungsdatum</div>
            <div>{{ asset.purchase_date|date_format }}</div>
        </div>
        <div>
            <div class="text-muted text-sm mb-4">AfA-Methode</div>
            <div>{{ methods.get(asset.depreciation_method, asset.depreciation_method) }}</div>
        </div>
    </div>
    <div class="form-row mt-16">
        <div>
            <div class="text-muted text-sm mb-4">Kaufpreis Brutto</div>
            <div>{{ asset.purchase_price_gross|currency }}</div>
        </div>
        <div>
            <div class="text-muted text-sm mb-4">Kaufpreis Netto (AfA-Basis)</div>
            <div>{{ asset.purchase_price_net|currency }}</div>
        </div>
    </div>
    {% if settings.tax_mode == 'regular' and asset.purchase_tax_treatment and asset.purchase_tax_treatment != 'none' %}
    <div class="form-row mt-16">
        <div>
            <div class="text-muted text-sm mb-4">Steuerbehandlung (Kauf)</div>
            <div>{{ tax_treatment_labels.get(asset.purchase_tax_treatment, asset.purchase_tax_treatment) }}
                {% if asset.purchase_tax_rate %} ({{ asset.purchase_tax_rate }}%){% endif %}
            </div>
        </div>
        <div>
            <div class="text-muted text-sm mb-4">Vorsteuer</div>
            <div>{{ (asset.purchase_tax_amount or 0)|currency }}</div>
        </div>
    </div>
    {% endif %}
    {% if asset.useful_life_months %}
    <div class="form-row mt-16">
        <div>
            <div class="text-muted text-sm mb-4">Nutzungsdauer</div>
            <div>{{ asset.useful_life_months }} Monate ({{ (asset.useful_life_months / 12)|round(1) }} Jahre)</div>
        </div>
        <div>
            <div class="text-muted text-sm mb-4">Erinnerungswert</div>
            <div>{{ (asset.salvage_value or 0)|currency }}</div>
        </div>
    </div>
    {% endif %}
    {% if asset.depreciation_category %}
    <div class="mt-16">
        <div class="text-muted text-sm mb-4">AfA-Kategorie</div>
        <div>{{ asset.depreciation_category.name }}</div>
    </div>
    {% endif %}
    {% set docs = get_documents('asset', asset.id) %}
    {% if docs %}
    <div class="mt-16">
        <div class="text-muted text-sm mb-4">Belege</div>
        {% for doc in docs %}
        <div class="mb-4">
            <a href="{{ url_for('admin.uploaded_file', filename=doc.filename) }}" target="_blank" class="text-accent">üìé {{ doc.original_filename or doc.filename }}</a>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% if asset.notes %}
    <div class="mt-16">
        <div class="text-muted text-sm mb-4">Notizen</div>
        <div>{{ asset.notes }}</div>
    </div>
    {% endif %}
</div>

<!-- Disposal Info -->
{% if asset.disposal_date %}
<div class="card">
    <div class="card-header text-danger">Abgang</div>
    <div class="form-row">
        <div>
            <div class="text-muted text-sm mb-4">Abgangsdatum</div>
            <div>{{ asset.disposal_date|date_format }}</div>
        </div>
        <div>
            <div class="text-muted text-sm mb-4">Grund</div>
            <div>
                {% if asset.disposal_reason == 'sold' %}Verkauft
                {% elif asset.disposal_reason == 'scrapped' %}Verschrottet / Entsorgt
                {% elif asset.disposal_reason == 'private_use' %}Privatentnahme
                {% else %}Sonstiger Abgang{% endif %}
            </div>
        </div>
    </div>
    {% if disposal_result %}
    <div class="price-summary mt-16">
        {% if not disposal_result.is_sammelposten %}
        <div class="price-row">
            <span>Buchwert bei Abgang</span>
            <span>{{ disposal_result.book_value_at_disposal|currency }}</span>
        </div>
        {% endif %}
        {% if asset.disposal_price_gross and asset.disposal_price_gross != asset.disposal_price %}
        <div class="price-row">
            <span>Verkaufserl√∂s (Brutto)</span>
            <span>{{ asset.disposal_price_gross|currency }}</span>
        </div>
        <div class="price-row">
            <span>Verkaufserl√∂s (Netto)</span>
            <span>{{ disposal_result.disposal_price|currency }}</span>
        </div>
        {% else %}
        <div class="price-row">
            <span>Verkaufserl√∂s</span>
            <span>{{ disposal_result.disposal_price|currency }}</span>
        </div>
        {% endif %}
        {% if settings.tax_mode == 'regular' and asset.disposal_tax_treatment and asset.disposal_tax_treatment != 'none' %}
        <div class="price-row">
            <span>USt auf Verkauf ({{ tax_treatment_labels.get(asset.disposal_tax_treatment, '') }}{% if asset.disposal_tax_rate %} {{ asset.disposal_tax_rate }}%{% endif %})</span>
            <span>{{ (asset.disposal_tax_amount or 0)|currency }}</span>
        </div>
        {% endif %}
        <div class="price-row total">
            <span>{{ 'Ver√§u√üerungsgewinn' if disposal_result.is_gain else 'Ver√§u√üerungsverlust' }}</span>
            <span class="{{ 'text-success' if disposal_result.is_gain else 'text-danger' }}">
                {{ disposal_result.gain_or_loss|currency }}
            </span>
        </div>
        {% if disposal_result.is_sammelposten %}
        <div class="mt-10 text-muted text-sm">
            ‚Ñπ Sammelposten: Abschreibung wird gem. ¬ß 6 Abs. 2a Satz 3 EStG unver√§ndert fortgesetzt.
        </div>
        {% endif %}
    </div>
    {% endif %}
    <div class="mt-16 d-flex gap-10">
        <a href="{{ url_for('admin.asset_dispose', id=asset.id) }}" class="btn btn-sm btn-outline">Abgang bearbeiten</a>
        <form method="POST" action="{{ url_for('admin.asset_undispose', id=asset.id) }}"
              onsubmit="return confirm('Abgang wirklich r√ºckg√§ngig machen?')">
            <button type="submit" class="btn btn-sm btn-outline">Abgang r√ºckg√§ngig machen</button>
        </form>
        {% if asset.disposal_reason == 'sold' and asset.disposal_price_gross and asset.disposal_price_gross > 0 %}
        <a href="{{ url_for('invoicing.quote_new', asset_id=asset.id) }}" class="btn btn-sm btn-primary">Angebot erstellen</a>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Linked Quotes / Invoices -->
{% set asset_quotes = asset.quotes.all() %}
{% set asset_invoices = asset.invoices.all() %}
{% if asset_quotes or asset_invoices %}
<div class="card">
    <div class="card-header">Verkn√ºpfte Angebote & Rechnungen</div>
    {% if asset_quotes %}
    <div class="text-muted text-sm mb-8"><strong>Angebote</strong></div>
    {% for q in asset_quotes %}
    <div class="d-flex justify-between align-center mb-8">
        <a href="{{ url_for('invoicing.quote_detail', id=q.id) }}" class="text-accent">
            {{ q.quote_number }} ‚Äì {{ q.date|date_format }}
        </a>
        <span class="badge {% if q.status == 'accepted' %}badge-success{% elif q.status == 'invoiced' %}badge-info{% elif q.status == 'rejected' %}badge-danger{% else %}badge-muted{% endif %}">
            {{ q.status|capitalize }}
        </span>
    </div>
    {% endfor %}
    {% endif %}
    {% if asset_invoices %}
    {% if asset_quotes %}<hr class="section-divider">{% endif %}
    <div class="text-muted text-sm mb-8"><strong>Rechnungen</strong></div>
    {% for inv in asset_invoices %}
    <div class="d-flex justify-between align-center mb-8">
        <a href="{{ url_for('invoicing.invoice_detail', id=inv.id) }}" class="text-accent">
            {{ inv.invoice_number }} ‚Äì {{ inv.date|date_format }} ‚Äì {{ inv.total|currency }}
        </a>
        <span class="badge {% if inv.status == 'paid' %}badge-success{% elif inv.status == 'cancelled' %}badge-danger{% else %}badge-muted{% endif %}">
            {{ inv.status|capitalize }}
        </span>
    </div>
    {% endfor %}
    {% endif %}
</div>
{% endif %}

<!-- Linked Account Transaction (Purchase) -->
<div class="card">
    <div class="card-header">Kontobuchung (Kauf)</div>
    {% if asset.bundle_id %}
    <p class="text-muted text-sm mb-16">Dieses Anlagegut ist Teil eines B√ºndels. Die Kontobuchung f√ºr den Kauf wird √ºber die B√ºndel-Detailseite verwaltet.</p>
    <a href="{{ url_for('admin.bundle_detail', bundle_id=asset.bundle_id) }}" class="btn btn-sm btn-outline">‚Üí B√ºndel-Details √∂ffnen</a>
    {% elif purchase_tx %}
    <div class="form-row">
        <div>
            <div class="text-muted text-sm mb-4">Verkn√ºpfte Buchung</div>
            <div>{{ purchase_tx.description }}</div>
        </div>
        <div>
            <div class="text-muted text-sm mb-4">Konto</div>
            <div>{{ purchase_tx.account.name if purchase_tx.account else '‚Äì' }}</div>
        </div>
    </div>
    <div class="form-row mt-16">
        <div>
            <div class="text-muted text-sm mb-4">Datum</div>
            <div>{{ purchase_tx.date|date_format }}</div>
        </div>
        <div>
            <div class="text-muted text-sm mb-4">Betrag</div>
            <div>{{ purchase_tx.amount|currency }}</div>
        </div>
    </div>
    <div class="mt-16">
        <form method="POST" action="{{ url_for('admin.asset_unlink_outflow', id=asset.id) }}"
              onsubmit="return confirm('Verkn√ºpfte Kontobuchung wirklich l√∂schen?')">
            <button type="submit" class="btn btn-sm btn-outline text-danger">Kontobuchung entfernen</button>
        </form>
    </div>
    {% else %}
    <p class="text-muted text-sm mb-16">Keine verkn√ºpfte Kontobuchung vorhanden. Sie k√∂nnen nachtr√§glich einen Abgang vom Konto buchen (erscheint nicht in der E√úR).</p>
    <form method="POST" action="{{ url_for('admin.asset_book_outflow', id=asset.id) }}" class="d-flex gap-10 align-center">
        <select name="outflow_account_id" required style="width: auto;">
            {% for acc in accounts %}
            <option value="{{ acc.id }}">{{ acc.name }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-sm btn-primary">Abgang buchen ({{ asset.purchase_price_gross|currency }})</button>
    </form>
    {% endif %}
</div>

<!-- Linked Account Transaction (Disposal) -->
{% if asset.disposal_date %}
<div class="card">
    <div class="card-header">Kontobuchung (Ver√§u√üerung)</div>
    {% if disposal_tx %}
    <div class="form-row">
        <div>
            <div class="text-muted text-sm mb-4">Verkn√ºpfte Buchung</div>
            <div>{{ disposal_tx.description }}</div>
        </div>
        <div>
            <div class="text-muted text-sm mb-4">Konto</div>
            <div>{{ disposal_tx.account.name if disposal_tx.account else '‚Äì' }}</div>
        </div>
    </div>
    <div class="form-row mt-16">
        <div>
            <div class="text-muted text-sm mb-4">Datum</div>
            <div>{{ disposal_tx.date|date_format }}</div>
        </div>
        <div>
            <div class="text-muted text-sm mb-4">Betrag</div>
            <div>{{ disposal_tx.amount|currency }}</div>
        </div>
    </div>
    <div class="mt-16">
        <form method="POST" action="{{ url_for('admin.asset_unlink_disposal_inflow', id=asset.id) }}"
              onsubmit="return confirm('Ver√§u√üerungsbuchung wirklich entfernen?')">
            <button type="submit" class="btn btn-sm btn-outline text-danger">Buchung entfernen</button>
        </form>
    </div>
    {% else %}
    <p class="text-muted text-sm mb-16">Keine Ver√§u√üerungsbuchung vorhanden. Sie k√∂nnen nachtr√§glich einen Zugang auf ein Konto buchen (erscheint nicht in der E√úR).</p>
    {% if asset.disposal_price_gross and asset.disposal_price_gross > 0 %}
    <form method="POST" action="{{ url_for('admin.asset_book_disposal_inflow', id=asset.id) }}" class="d-flex gap-10 align-center">
        <select name="inflow_account_id" required style="width: auto;">
            {% for acc in accounts %}
            <option value="{{ acc.id }}">{{ acc.name }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-sm btn-primary">Zugang buchen ({{ asset.disposal_price_gross|currency }})</button>
    </form>
    {% else %}
    <p class="text-muted text-sm">Kein Verkaufserl√∂s vorhanden.</p>
    {% endif %}
    {% endif %}
</div>
{% endif %}

<!-- Depreciation Schedule -->
<div class="card">
    <div class="card-header">Abschreibungsplan</div>
    {% if schedule %}
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Jahr</th>
                    <th style="text-align: right;">AfA-Betrag</th>
                    <th style="text-align: right;">Kumuliert</th>
                    <th style="text-align: right;">Buchwert</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in schedule %}
                <tr class="{{ 'font-semibold' if entry.year == current_year }}">
                    <td>
                        {{ entry.year }}
                        {% if entry.year == current_year %}
                        <span class="badge badge-info">aktuell</span>
                        {% endif %}
                    </td>
                    <td style="text-align: right;">{{ entry.amount|currency }}</td>
                    <td style="text-align: right;">{{ entry.cumulative|currency }}</td>
                    <td style="text-align: right;">{{ entry.book_value|currency }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">Keine Abschreibungsdaten vorhanden.</div>
    {% endif %}
</div>

<!-- Delete -->
<div class="card">
    <div class="card-header text-danger">Gefahrenzone</div>
    <p class="text-muted text-sm mb-16">Das L√∂schen eines Anlageguts kann nicht r√ºckg√§ngig gemacht werden.</p>
    <form method="POST" action="{{ url_for('admin.asset_delete', id=asset.id) }}"
          onsubmit="return confirm('Anlagegut wirklich unwiderruflich l√∂schen?')">
        <button type="submit" class="btn btn-danger">Anlagegut l√∂schen</button>
    </form>
</div>
{% endblock %}
