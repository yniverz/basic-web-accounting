{% extends "admin/base.html" %}
{% block title %}{{ 'Abgang bearbeiten' if is_edit else 'Abgang erfassen' }} - {{ asset.name }} - {{ site_settings.business_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ 'Abgang bearbeiten' if is_edit else 'Abgang erfassen' }}</h1>
    <a href="{{ url_for('admin.asset_detail', id=asset.id) }}" class="btn btn-outline">← Zurück</a>
</div>

<div class="card">
    <div class="card-header">{{ asset.name }}</div>
    <div class="form-row mb-20">
        <div>
            <div class="text-muted text-sm mb-4">Anschaffungskosten (Netto)</div>
            <div class="font-semibold">{{ asset.purchase_price_net|currency }}</div>
        </div>
        <div>
            <div class="text-muted text-sm mb-4">Aktueller Buchwert</div>
            <div class="font-semibold">{{ book_value|currency }}</div>
        </div>
    </div>

    {% if asset.depreciation_method == 'sammelposten' %}
    <div class="alert alert-info">
        ℹ <strong>Sammelposten-Hinweis:</strong> Bei Wirtschaftsgütern im Sammelposten wird die Abschreibung
        gem. § 6 Abs. 2a Satz 3 EStG auch nach dem Abgang unverändert fortgesetzt.
        Der Verkaufserlös wird als Betriebseinnahme erfasst.
    </div>
    {% endif %}

    <hr class="section-divider">

    <form method="POST">
        <div class="form-row">
            <div class="form-group">
                <label for="disposal_date">Abgangsdatum</label>
                <input type="date" id="disposal_date" name="disposal_date"
                       value="{{ asset.disposal_date.isoformat() if is_edit and asset.disposal_date else today }}" required>
            </div>
            <div class="form-group">
                <label for="disposal_reason">Grund</label>
                <select id="disposal_reason" name="disposal_reason" required>
                    <option value="sold" {{ 'selected' if is_edit and asset.disposal_reason == 'sold' }}>Verkauft</option>
                    <option value="scrapped" {{ 'selected' if is_edit and asset.disposal_reason == 'scrapped' }}>Verschrottet / Entsorgt</option>
                    <option value="private_use" {{ 'selected' if is_edit and asset.disposal_reason == 'private_use' }}>Privatentnahme</option>
                    <option value="other" {{ 'selected' if is_edit and asset.disposal_reason == 'other' }}>Sonstiger Abgang</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="disposal_price_gross">Verkaufserlös Brutto (€)</label>
                <input type="number" id="disposal_price_gross" name="disposal_price_gross"
                       step="0.01" min="0"
                       value="{{ asset.disposal_price_gross if is_edit and asset.disposal_price_gross else (asset.disposal_price if is_edit and asset.disposal_price else 0) }}"
                       placeholder="0,00"
                       oninput="calculateDisposalNet()">
                <span class="text-muted text-xs mt-4 d-inline">0 € bei Verschrottung oder Entsorgung</span>
            </div>
            <div class="form-group">
                <label for="disposal_price">Verkaufserlös Netto (€) <span class="text-muted text-sm">— für Gewinn/Verlust-Berechnung</span></label>
                <input type="number" id="disposal_price" name="disposal_price"
                       step="0.01" min="0"
                       value="{{ asset.disposal_price if is_edit and asset.disposal_price else 0 }}"
                       placeholder="0,00"
                       oninput="onDisposalNetManual()">
            </div>
        </div>

        <div id="result-preview" class="price-summary mt-16" style="display: none;">
            <div class="price-row">
                <span>Buchwert bei Abgang</span>
                <span id="preview-book-value">{{ book_value|currency }}</span>
            </div>
            <div class="price-row">
                <span>Verkaufserlös</span>
                <span id="preview-sale-price">0,00 €</span>
            </div>
            <div class="price-row total">
                <span id="preview-label">Ergebnis</span>
                <span id="preview-result">0,00 €</span>
            </div>
        </div>

        <hr class="section-divider">

        <div class="d-flex gap-10">
            <button type="submit" class="btn btn-warning">{{ 'Abgang aktualisieren' if is_edit else 'Abgang erfassen' }}</button>
            <a href="{{ url_for('admin.asset_detail', id=asset.id) }}" class="btn btn-outline">Abbrechen</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
var bookValue = {{ book_value }};
var isSammelposten = {{ 'true' if asset.depreciation_method == 'sammelposten' else 'false' }};
var taxRate = {{ site_settings.tax_rate if site_settings.tax_mode == 'regular' else 0 }};
var netManual = false;

function calculateDisposalNet() {
    var gross = parseFloat(document.getElementById('disposal_price_gross').value) || 0;
    if (!netManual) {
        var net = taxRate > 0 ? gross / (1 + taxRate / 100) : gross;
        document.getElementById('disposal_price').value = net.toFixed(2);
    }
    updateResult();
}

function onDisposalNetManual() {
    netManual = true;
    updateResult();
}

function updateResult() {
    var salePrice = parseFloat(document.getElementById('disposal_price').value) || 0;
    var preview = document.getElementById('result-preview');
    preview.style.display = '';

    document.getElementById('preview-sale-price').textContent = formatCurrency(salePrice);

    if (isSammelposten) {
        document.getElementById('preview-label').textContent = 'Betriebseinnahme';
        document.getElementById('preview-result').textContent = formatCurrency(salePrice);
        document.getElementById('preview-result').className = 'text-success';
    } else {
        var result = salePrice - bookValue;
        if (result >= 0) {
            document.getElementById('preview-label').textContent = 'Veräußerungsgewinn';
            document.getElementById('preview-result').className = 'text-success';
        } else {
            document.getElementById('preview-label').textContent = 'Veräußerungsverlust';
            document.getElementById('preview-result').className = 'text-danger';
        }
        document.getElementById('preview-result').textContent = formatCurrency(result);
    }
}

function formatCurrency(value) {
    return value.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';
}

// Init: trigger preview if editing
{% if is_edit %}
updateResult();
{% endif %}
</script>
{% endblock %}
