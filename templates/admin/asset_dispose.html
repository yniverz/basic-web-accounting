{% extends "admin/base.html" %}
{% block title %}{{ 'Abgang bearbeiten' if is_edit else 'Abgang erfassen' }} - {{ asset.name }} - {{ brand_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ 'Abgang bearbeiten' if is_edit else 'Abgang erfassen' }}</h1>
    <a href="{{ url_for('admin.asset_detail', id=asset.id) }}" class="btn btn-outline">← Zurück</a>
</div>

<div class="card">
    <div class="card-header">{{ asset.name }}</div>
    <div class="form-row mb-20">
        <div>
            <div class="text-muted text-sm mb-4">Anschaffungskosten (Netto)</div>
            <div class="font-semibold">{{ asset.purchase_price_net|currency }}</div>
        </div>
        <div>
            <div class="text-muted text-sm mb-4">Aktueller Buchwert</div>
            <div class="font-semibold">{{ book_value|currency }}</div>
        </div>
    </div>

    {% if asset.depreciation_method == 'sammelposten' %}
    <div class="alert alert-info">
        ℹ <strong>Sammelposten-Hinweis:</strong> Bei Wirtschaftsgütern im Sammelposten wird die Abschreibung
        gem. § 6 Abs. 2a Satz 3 EStG auch nach dem Abgang unverändert fortgesetzt.
        Der Verkaufserlös wird als Betriebseinnahme erfasst.
    </div>
    {% endif %}

    <hr class="section-divider">

    <form method="POST">
        <div class="form-row">
            <div class="form-group">
                <label for="disposal_date">Abgangsdatum</label>
                <input type="date" id="disposal_date" name="disposal_date"
                       value="{{ asset.disposal_date.isoformat() if is_edit and asset.disposal_date else today }}" required>
            </div>
            <div class="form-group">
                <label for="disposal_reason">Grund</label>
                <select id="disposal_reason" name="disposal_reason" required>
                    <option value="sold" {{ 'selected' if is_edit and asset.disposal_reason == 'sold' }}>Verkauft</option>
                    <option value="scrapped" {{ 'selected' if is_edit and asset.disposal_reason == 'scrapped' }}>Verschrottet / Entsorgt</option>
                    <option value="private_use" {{ 'selected' if is_edit and asset.disposal_reason == 'private_use' }}>Privatentnahme</option>
                    <option value="other" {{ 'selected' if is_edit and asset.disposal_reason == 'other' }}>Sonstiger Abgang</option>
                </select>
            </div>
        </div>

        {% if settings.tax_mode == 'regular' %}
        <!-- Tax Treatment for Disposal -->
        <div class="form-row">
            <div class="form-group">
                <label for="disposal_tax_treatment">Steuerbehandlung (Verkauf)</label>
                <select id="disposal_tax_treatment" name="disposal_tax_treatment" onchange="updateDisposalTax()">
                    {% for key, label in tax_treatment_labels.items() %}
                    <option value="{{ key }}"
                            {{ 'selected' if is_edit and asset.disposal_tax_treatment == key }}>
                        {{ label }}{% if key == 'standard' %} ({{ settings.tax_rate }}%){% elif key == 'reduced' %} ({{ settings.tax_rate_reduced }}%){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group" id="disposal_custom_rate_group" style="display: none;">
                <label for="disposal_custom_tax_rate">Steuersatz (%)</label>
                <input type="number" id="disposal_custom_tax_rate" name="disposal_custom_tax_rate" step="0.1" min="0" max="100"
                       value="{{ asset.disposal_tax_rate if is_edit and asset.disposal_tax_treatment == 'custom' else '' }}"
                       placeholder="z.B. 5.0" onchange="recalcDisposal()">
            </div>
        </div>
        {% else %}
        <input type="hidden" name="disposal_tax_treatment" value="none">
        {% endif %}

        <!-- Input Mode for Disposal -->
        <div class="form-row">
            <div class="form-group">
                <label>Eingabemodus</label>
                <div class="d-flex gap-10">
                    <label class="radio-label">
                        <input type="radio" name="disposal_input_mode" value="gross" checked onchange="toggleDisposalMode()"> Brutto
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="disposal_input_mode" value="net" onchange="toggleDisposalMode()"> Netto
                    </label>
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group" id="disposal_gross_group">
                <label for="disposal_price_gross">Verkaufserlös Brutto (€)</label>
                <input type="number" id="disposal_price_gross" name="disposal_price_gross"
                       step="0.01" min="0"
                       value="{{ asset.disposal_price_gross if is_edit and asset.disposal_price_gross else 0 }}"
                       placeholder="0,00"
                       oninput="recalcDisposal()">
                <span class="text-muted text-xs mt-4 d-inline">0 € bei Verschrottung oder Entsorgung</span>
            </div>
            <div class="form-group" id="disposal_net_group" style="display: none;">
                <label for="disposal_price">Verkaufserlös Netto (€)</label>
                <input type="number" id="disposal_price" name="disposal_price"
                       step="0.01" min="0"
                       value="{{ asset.disposal_price if is_edit and asset.disposal_price else 0 }}"
                       placeholder="0,00"
                       oninput="recalcDisposal()">
            </div>
        </div>

        {% if settings.tax_mode == 'regular' %}
        <!-- Disposal Tax Summary -->
        <div class="card" style="background: var(--bg-secondary); padding: 12px 16px; margin-bottom: 16px;">
            <div class="d-flex justify-between text-sm">
                <span>Netto:</span>
                <span id="disposal_calc_net">–</span>
            </div>
            <div class="d-flex justify-between text-sm">
                <span>USt (<span id="disposal_calc_rate">0</span>%):</span>
                <span id="disposal_calc_tax">–</span>
            </div>
            <div class="d-flex justify-between text-sm font-semibold" style="border-top: 1px solid var(--border-color); padding-top: 4px; margin-top: 4px;">
                <span>Brutto:</span>
                <span id="disposal_calc_gross">–</span>
            </div>
        </div>
        {% endif %}

        <div id="result-preview" class="price-summary mt-16" style="display: none;">
            <div class="price-row">
                <span>Buchwert bei Abgang</span>
                <span id="preview-book-value">{{ book_value|currency }}</span>
            </div>
            <div class="price-row">
                <span>Verkaufserlös (Netto)</span>
                <span id="preview-sale-price">0,00 €</span>
            </div>
            <div class="price-row total">
                <span id="preview-label">Ergebnis</span>
                <span id="preview-result">0,00 €</span>
            </div>
        </div>

        <!-- Optional: Book disposal proceeds to account -->
        <hr class="section-divider">
        <div class="card-header">Kontobuchung</div>
        <div class="form-group">
            <label class="radio-label">
                <input type="checkbox" name="book_inflow" id="book_inflow" value="1" {{ 'checked' if not is_edit or existing_disposal_tx }} onchange="toggleInflowAccount()">
                Zugang auf Konto buchen
            </label>
            <span class="text-muted text-xs d-inline">Erstellt eine verknüpfte Buchung als Kontozugang (erscheint nicht in der EÜR)</span>
        </div>
        <div class="form-group" id="inflow_account_group" {% if is_edit and not existing_disposal_tx %}style="display: none;"{% endif %}>
            <label for="inflow_account_id">Konto</label>
            <select id="inflow_account_id" name="inflow_account_id">
                {% for acc in accounts %}
                <option value="{{ acc.id }}" {{ 'selected' if existing_disposal_tx and existing_disposal_tx.account_id == acc.id }}>{{ acc.name }}</option>
                {% endfor %}
            </select>
        </div>

        <hr class="section-divider">

        <div class="d-flex gap-10">
            <button type="submit" class="btn btn-warning">{{ 'Abgang aktualisieren' if is_edit else 'Abgang erfassen' }}</button>
            <a href="{{ url_for('admin.asset_detail', id=asset.id) }}" class="btn btn-outline">Abbrechen</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleInflowAccount() {
    var cb = document.getElementById('book_inflow');
    var grp = document.getElementById('inflow_account_group');
    if (cb && grp) grp.style.display = cb.checked ? '' : 'none';
}

var bookValue = {{ book_value }};
var isSammelposten = {{ 'true' if asset.depreciation_method == 'sammelposten' else 'false' }};
var standardRate = {{ settings.tax_rate if settings else 19 }};
var reducedRate = {{ settings.tax_rate_reduced if settings and settings.tax_rate_reduced else 7 }};
var isRegular = {{ 'true' if settings and settings.tax_mode == 'regular' else 'false' }};

function getDisposalRate() {
    if (!isRegular) return 0;
    var sel = document.getElementById('disposal_tax_treatment');
    if (!sel) return 0;
    var val = sel.value;
    if (val === 'standard') return standardRate;
    if (val === 'reduced') return reducedRate;
    if (val === 'custom') return parseFloat(document.getElementById('disposal_custom_tax_rate').value) || 0;
    return 0;
}

function updateDisposalTax() {
    var sel = document.getElementById('disposal_tax_treatment');
    if (!sel) return;
    var cg = document.getElementById('disposal_custom_rate_group');
    if (cg) cg.style.display = (sel.value === 'custom') ? '' : 'none';
    recalcDisposal();
}

function toggleDisposalMode() {
    var mode = document.querySelector('input[name="disposal_input_mode"]:checked').value;
    var grossGrp = document.getElementById('disposal_gross_group');
    var netGrp = document.getElementById('disposal_net_group');
    if (mode === 'net') {
        grossGrp.style.display = 'none';
        netGrp.style.display = '';
    } else {
        grossGrp.style.display = '';
        netGrp.style.display = 'none';
    }
    recalcDisposal();
}

function recalcDisposal() {
    var rate = getDisposalRate();
    var mode = document.querySelector('input[name="disposal_input_mode"]:checked').value;
    var net, gross, tax;

    if (mode === 'net') {
        net = parseFloat(document.getElementById('disposal_price').value) || 0;
        tax = rate > 0 ? net * (rate / 100) : 0;
        gross = net + tax;
    } else {
        gross = parseFloat(document.getElementById('disposal_price_gross').value) || 0;
        net = rate > 0 ? gross / (1 + rate / 100) : gross;
        tax = gross - net;
    }

    if (isRegular) {
        var cn = document.getElementById('disposal_calc_net');
        var ct = document.getElementById('disposal_calc_tax');
        var cg = document.getElementById('disposal_calc_gross');
        var cr = document.getElementById('disposal_calc_rate');
        if (cn) cn.textContent = net.toFixed(2) + ' €';
        if (ct) ct.textContent = tax.toFixed(2) + ' €';
        if (cg) cg.textContent = gross.toFixed(2) + ' €';
        if (cr) cr.textContent = rate.toFixed(1);
    }

    updateResult(net);
}

function updateResult(saleNet) {
    if (saleNet === undefined) {
        var mode = document.querySelector('input[name="disposal_input_mode"]:checked').value;
        var rate = getDisposalRate();
        if (mode === 'net') {
            saleNet = parseFloat(document.getElementById('disposal_price').value) || 0;
        } else {
            var gross = parseFloat(document.getElementById('disposal_price_gross').value) || 0;
            saleNet = rate > 0 ? gross / (1 + rate / 100) : gross;
        }
    }

    var preview = document.getElementById('result-preview');
    preview.style.display = '';

    document.getElementById('preview-sale-price').textContent = formatCurrency(saleNet);

    if (isSammelposten) {
        document.getElementById('preview-label').textContent = 'Betriebseinnahme';
        document.getElementById('preview-result').textContent = formatCurrency(saleNet);
        document.getElementById('preview-result').className = 'text-success';
    } else {
        var result = saleNet - bookValue;
        if (result >= 0) {
            document.getElementById('preview-label').textContent = 'Veräußerungsgewinn';
            document.getElementById('preview-result').className = 'text-success';
        } else {
            document.getElementById('preview-label').textContent = 'Veräußerungsverlust';
            document.getElementById('preview-result').className = 'text-danger';
        }
        document.getElementById('preview-result').textContent = formatCurrency(result);
    }
}

function formatCurrency(value) {
    return value.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';
}

// Init
updateDisposalTax();
{% if is_edit %}
recalcDisposal();
{% endif %}
</script>
{% endblock %}
