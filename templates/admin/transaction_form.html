{% extends "admin/base.html" %}
{% block title %}{{ 'Buchung bearbeiten' if transaction else 'Neue Buchung' }} - {{ brand_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ 'Buchung bearbeiten' if transaction else 'Neue Buchung' }}</h1>
    <a href="{{ url_for('admin.transactions') }}" class="btn btn-outline">‚Üê Zur√ºck</a>
</div>

<div class="card">
    <form method="POST" enctype="multipart/form-data">
        <div class="form-row">
            <div class="form-group">
                <label for="date">Datum</label>
                <input type="date" id="date" name="date"
                       value="{{ transaction.date.isoformat() if transaction else today }}" required>
            </div>
            <div class="form-group">
                <label for="type">Typ</label>
                <select id="type" name="type" required onchange="filterCategories()">
                    <option value="income" {{ 'selected' if transaction and transaction.type == 'income' }}>Einnahme</option>
                    <option value="expense" {{ 'selected' if not transaction or transaction.type == 'expense' }}>Ausgabe</option>
                </select>
            </div>
            <div class="form-group">
                <label for="account_id">Konto</label>
                <select id="account_id" name="account_id" required>
                    {% for acc in accounts %}
                    <option value="{{ acc.id }}" {{ 'selected' if transaction and transaction.account_id == acc.id }}>{{ acc.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="form-group">
            <label for="description">Beschreibung</label>
            <input type="text" id="description" name="description"
                   value="{{ transaction.description if transaction else '' }}" required
                   placeholder="z.B. Rechnung #123, B√ºromaterial, etc.">
        </div>

        {% if settings.tax_mode == 'regular' %}
        <!-- Tax Treatment -->
        <div class="form-row">
            <div class="form-group">
                <label for="tax_treatment">Steuerbehandlung</label>
                <select id="tax_treatment" name="tax_treatment" onchange="updateTaxFields()">
                    {% for key, label in tax_treatment_labels.items() %}
                    <option value="{{ key }}"
                            data-rate="{% if key == 'standard' %}{{ settings.tax_rate }}{% elif key == 'reduced' %}{{ settings.tax_rate_reduced }}{% elif key == 'custom' %}0{% else %}0{% endif %}"
                            {{ 'selected' if transaction and transaction.tax_treatment == key }}>
                        {{ label }}{% if key == 'standard' %} ({{ settings.tax_rate }}%){% elif key == 'reduced' %} ({{ settings.tax_rate_reduced }}%){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group" id="custom_rate_group" style="display: none;">
                <label for="custom_tax_rate">Steuersatz (%)</label>
                <input type="number" id="custom_tax_rate" name="custom_tax_rate" step="0.1" min="0" max="100"
                       value="{{ transaction.tax_rate if transaction and transaction.tax_treatment == 'custom' else '' }}"
                       placeholder="z.B. 5.0" onchange="recalculate()">
            </div>
        </div>
        {% else %}
        <input type="hidden" name="tax_treatment" value="none">
        {% endif %}

        <!-- Amount Input Mode -->
        <div class="form-row">
            <div class="form-group">
                <label>Eingabemodus</label>
                <div class="d-flex gap-10">
                    <label class="radio-label">
                        <input type="radio" name="input_mode" value="gross" checked onchange="toggleInputMode()"> Brutto
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="input_mode" value="net" onchange="toggleInputMode()"> Netto
                    </label>
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group" id="gross_input_group">
                <label for="amount">Betrag Brutto (‚Ç¨)</label>
                <input type="number" id="amount" name="amount" step="0.01" min="0.01"
                       value="{{ transaction.amount if transaction else '' }}" required
                       placeholder="0,00" oninput="recalculate()">
            </div>
            <div class="form-group" id="net_input_group" style="display: none;">
                <label for="net_input">Betrag Netto (‚Ç¨)</label>
                <input type="number" id="net_input" name="net_input" step="0.01" min="0.01"
                       value="{{ transaction.net_amount if transaction else '' }}"
                       placeholder="0,00" oninput="recalculate()">
            </div>
            <div class="form-group">
                <label for="category_id">Kategorie</label>
                <select id="category_id" name="category_id">
                    <option value="">‚Äì Keine Kategorie ‚Äì</option>
                    {% for c in categories %}
                    <option value="{{ c.id }}"
                            data-type="{{ c.type }}"
                            {{ 'selected' if transaction and transaction.category_id == c.id }}>
                        {{ c.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        {% if settings.tax_mode == 'regular' %}
        <!-- Calculated Tax Summary -->
        <div class="card" id="tax_summary" style="background: var(--bg-secondary); padding: 12px 16px; margin-bottom: 16px;">
            <div class="d-flex justify-between text-sm">
                <span>Netto:</span>
                <span id="calc_net">‚Äì</span>
            </div>
            <div class="d-flex justify-between text-sm">
                <span id="tax_label">USt/VSt (<span id="calc_rate">0</span>%):</span>
                <span id="calc_tax">‚Äì</span>
            </div>
            <div class="d-flex justify-between text-sm font-semibold" style="border-top: 1px solid var(--border-color); padding-top: 4px; margin-top: 4px;">
                <span>Brutto:</span>
                <span id="calc_gross">‚Äì</span>
            </div>
        </div>
        {% endif %}

        <div class="form-group">
            <label for="notes">Notizen</label>
            <textarea id="notes" name="notes" rows="3"
                      placeholder="Optionale Notizen...">{{ transaction.notes if transaction and transaction.notes else '' }}</textarea>
        </div>

        <div class="form-group">
            <label for="documents">Belege / Dokumente</label>
            <input type="file" id="documents" name="documents" accept=".pdf,.png,.jpg,.jpeg,.gif,.webp" multiple>
            <div class="text-muted text-xs mt-4">Mehrere Dateien m√∂glich (PDF, PNG, JPG, GIF, WebP)</div>
            {% if transaction %}
            {% set docs = get_documents('transaction', transaction.id) %}
            {% if docs %}
            <div class="mt-6">
                <div class="text-sm text-muted mb-4">Vorhandene Dokumente:</div>
                {% for doc in docs %}
                <div class="d-flex align-center gap-6 mb-4">
                    <label class="text-sm">
                        <input type="checkbox" name="remove_documents" value="{{ doc.id }}">
                        Entfernen
                    </label>
                    <a href="{{ url_for('admin.uploaded_file', filename=doc.filename) }}" target="_blank" class="text-accent text-sm">üìé {{ doc.original_filename or doc.filename }}</a>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endif %}
            {% if transaction and transaction.linked_asset_id %}
            {% set asset_docs = get_documents('asset', transaction.linked_asset_id) %}
            {% if asset_docs %}
            <div class="mt-6">
                <div class="text-sm text-muted mb-4">Dokumente vom Anlagegut:</div>
                {% for doc in asset_docs %}
                <div class="mb-4">
                    <a href="{{ url_for('admin.uploaded_file', filename=doc.filename) }}" target="_blank" class="text-accent text-sm">üìÑ {{ doc.original_filename or doc.filename }}</a>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endif %}
        </div>

        <hr class="section-divider">

        <div class="d-flex gap-10">
            <button type="submit" class="btn btn-primary">
                {{ 'Speichern' if transaction else 'Buchung erstellen' }}
            </button>
            <a href="{{ url_for('admin.transactions') }}" class="btn btn-outline">Abbrechen</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
var standardRate = {{ settings.tax_rate if settings else 19 }};
var reducedRate = {{ settings.tax_rate_reduced if settings and settings.tax_rate_reduced else 7 }};
var isRegular = {{ 'true' if settings and settings.tax_mode == 'regular' else 'false' }};

function filterCategories() {
    var type = document.getElementById('type').value;
    var options = document.querySelectorAll('#category_id option[data-type]');
    options.forEach(function(opt) {
        opt.style.display = (opt.dataset.type === type) ? '' : 'none';
        if (opt.style.display === 'none' && opt.selected) {
            opt.selected = false;
        }
    });
}

function getEffectiveRate() {
    if (!isRegular) return 0;
    var treatment = document.getElementById('tax_treatment');
    if (!treatment) return 0;
    var val = treatment.value;
    if (val === 'standard') return standardRate;
    if (val === 'reduced') return reducedRate;
    if (val === 'custom') {
        return parseFloat(document.getElementById('custom_tax_rate').value) || 0;
    }
    return 0;
}

function updateTaxFields() {
    var treatment = document.getElementById('tax_treatment');
    if (!treatment) return;
    var customGroup = document.getElementById('custom_rate_group');
    if (customGroup) {
        customGroup.style.display = (treatment.value === 'custom') ? '' : 'none';
    }
    recalculate();
}

function toggleInputMode() {
    var mode = document.querySelector('input[name="input_mode"]:checked').value;
    var grossGroup = document.getElementById('gross_input_group');
    var netGroup = document.getElementById('net_input_group');
    var amountInput = document.getElementById('amount');
    var netInput = document.getElementById('net_input');

    if (mode === 'net') {
        grossGroup.style.display = 'none';
        netGroup.style.display = '';
        amountInput.removeAttribute('required');
        netInput.setAttribute('required', '');
    } else {
        grossGroup.style.display = '';
        netGroup.style.display = 'none';
        amountInput.setAttribute('required', '');
        netInput.removeAttribute('required');
    }
    recalculate();
}

function recalculate() {
    if (!isRegular) return;
    var rate = getEffectiveRate();
    var mode = document.querySelector('input[name="input_mode"]:checked').value;
    var calcNet = document.getElementById('calc_net');
    var calcTax = document.getElementById('calc_tax');
    var calcGross = document.getElementById('calc_gross');
    var calcRate = document.getElementById('calc_rate');

    if (calcRate) calcRate.textContent = rate.toFixed(1);

    var net, gross, tax;
    if (mode === 'net') {
        net = parseFloat(document.getElementById('net_input').value) || 0;
        tax = rate > 0 ? net * (rate / 100) : 0;
        gross = net + tax;
    } else {
        gross = parseFloat(document.getElementById('amount').value) || 0;
        net = rate > 0 ? gross / (1 + rate / 100) : gross;
        tax = gross - net;
    }

    if (calcNet) calcNet.textContent = net.toFixed(2) + ' ‚Ç¨';
    if (calcTax) calcTax.textContent = tax.toFixed(2) + ' ‚Ç¨';
    if (calcGross) calcGross.textContent = gross.toFixed(2) + ' ‚Ç¨';
}

// Init
filterCategories();
updateTaxFields();
recalculate();
</script>
{% endblock %}
