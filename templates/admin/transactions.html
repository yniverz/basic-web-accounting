{% extends "admin/base.html" %}
{% block title %}Buchungen - {{ site_settings.business_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Buchungen</h1>
    <div class="d-flex gap-6">
        <a href="{{ url_for('admin.transfer_new') }}" class="btn btn-outline">â†” Umbuchung</a>
        <a href="{{ url_for('admin.transaction_new') }}" class="btn btn-primary">+ Neue Buchung</a>
    </div>
</div>

<!-- Filters -->
<div class="filter-bar">
    <form method="GET" class="d-flex gap-12 align-end flex-wrap w-full">
        <div class="form-group">
            <label for="year">Jahr</label>
            <select name="year" id="year" style="width: auto;">
                {% for y in years %}
                <option value="{{ y }}" {{ 'selected' if y == year }}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="month">Monat</label>
            <select name="month" id="month" style="width: auto;">
                <option value="0">Alle</option>
                {% for m_id, m_name in months.items() %}
                <option value="{{ m_id }}" {{ 'selected' if m_id == month }}>{{ m_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="type">Typ</label>
            <select name="type" id="type" style="width: auto;">
                <option value="">Alle</option>
                <option value="income" {{ 'selected' if type_filter == 'income' }}>Einnahmen</option>
                <option value="expense" {{ 'selected' if type_filter == 'expense' }}>Ausgaben</option>
                <option value="transfer" {{ 'selected' if type_filter == 'transfer' }}>Umbuchungen</option>
            </select>
        </div>
        <div class="form-group">
            <label for="category">Kategorie</label>
            <select name="category" id="category" style="width: auto;">
                <option value="0">Alle</option>
                {% for c in categories %}
                <option value="{{ c.id }}" {{ 'selected' if c.id == category_id }}>{{ c.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="account">Konto</label>
            <select name="account" id="account" style="width: auto;">
                <option value="0">Alle</option>
                {% for acc in accounts %}
                <option value="{{ acc.id }}" {{ 'selected' if acc.id == account_id }}>{{ acc.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <button type="submit" class="btn">Filtern</button>
        </div>
    </form>
</div>

<!-- Summary -->
<div class="stats-grid">
    <div class="stat-card stat-success">
        <div class="stat-label">Einnahmen (gefiltert)</div>
        <div class="stat-value text-success">{{ total_income|currency }}</div>
    </div>
    <div class="stat-card stat-danger">
        <div class="stat-label">Ausgaben (gefiltert)</div>
        <div class="stat-value text-danger">{{ total_expenses|currency }}</div>
    </div>
</div>

<!-- Transactions Table -->
{% if transactions %}
<div class="card" style="padding: 0; overflow: hidden;">
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Datum</th>
                    <th>Beschreibung</th>
                    <th>Konto</th>
                    <th>Kategorie</th>
                    <th>Typ</th>
                    <th style="text-align: right;">Brutto</th>
                    {% if site_settings.tax_mode == 'regular' %}
                    <th style="text-align: right;">Netto</th>
                    <th style="text-align: right;">USt/VSt</th>
                    <th>Steuer</th>
                    {% endif %}
                    <th>Beleg</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody>
                {% for t in transactions %}
                <tr>
                    <td>{{ t.date|date_format }}</td>
                    <td>
                        {{ t.description }}
                        {% if t.linked_asset_id %}
                        <span class="badge badge-info" style="margin-left:4px">Anlagegut</span>
                        {% endif %}
                        {% if t.notes %}
                        <br><span class="text-muted text-sm">{{ t.notes[:80] }}{{ '...' if t.notes|length > 80 }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if t.account %}
                        {{ t.account.name }}
                        {% endif %}
                        {% if t.type == 'transfer' and t.transfer_to_account %}
                        â†’ {{ t.transfer_to_account.name }}
                        {% endif %}
                    </td>
                    <td>{{ t.category.name if t.category else 'â€“' }}</td>
                    <td>
                        {% if t.type == 'transfer' %}
                        <span class="badge">Umbuchung</span>
                        {% elif t.type == 'income' %}
                        <span class="badge badge-income">Einnahme</span>
                        {% else %}
                        <span class="badge badge-expense">Ausgabe</span>
                        {% endif %}
                    </td>
                    <td style="text-align: right; white-space: nowrap;">{{ t.amount|currency }}</td>
                    {% if site_settings.tax_mode == 'regular' %}
                    <td style="text-align: right; white-space: nowrap;">{{ (t.net_amount or t.amount)|currency }}</td>
                    <td style="text-align: right; white-space: nowrap;">{{ (t.tax_amount or 0)|currency }}</td>
                    <td style="white-space: nowrap;">
                        {% if t.tax_treatment == 'standard' %}
                        <span class="text-sm">{{ t.tax_rate or site_settings.tax_rate }}%</span>
                        {% elif t.tax_treatment == 'reduced' %}
                        <span class="text-sm">{{ t.tax_rate or site_settings.tax_rate_reduced }}% erm.</span>
                        {% elif t.tax_treatment == 'reverse_charge' %}
                        <span class="text-sm text-muted">RC Â§13b</span>
                        {% elif t.tax_treatment == 'intra_eu' %}
                        <span class="text-sm text-muted">ig.</span>
                        {% elif t.tax_treatment == 'tax_free' %}
                        <span class="text-sm text-muted">stfrei</span>
                        {% elif t.tax_treatment == 'custom' %}
                        <span class="text-sm">{{ t.tax_rate }}%</span>
                        {% else %}
                        <span class="text-sm text-muted">â€“</span>
                        {% endif %}
                    </td>
                    {% endif %}
                    <td>
                        {% if t.document_filename %}
                        <a href="{{ url_for('admin.uploaded_file', filename=t.document_filename) }}" target="_blank" class="text-accent text-sm">ðŸ“Ž Beleg</a>
                        {% else %}
                        <span class="text-muted text-sm">â€“</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="d-flex gap-6">
                            {% if not t.linked_asset_id and t.type != 'transfer' %}
                            <a href="{{ url_for('admin.transaction_edit', id=t.id) }}" class="btn btn-sm btn-outline">Bearbeiten</a>
                            <form method="POST" action="{{ url_for('admin.transaction_delete', id=t.id) }}" onsubmit="return confirm('Buchung wirklich lÃ¶schen?')">
                                <button type="submit" class="btn btn-sm btn-danger">LÃ¶schen</button>
                            </form>
                            {% elif t.linked_asset_id %}
                            <a href="{{ url_for('admin.asset_detail', id=t.linked_asset_id) }}" class="btn btn-sm btn-outline">Zum Anlagegut</a>
                            {% else %}
                            <span class="text-muted text-sm">Umbuchung</span>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="card empty-state">
    <p>Keine Buchungen gefunden.</p>
    <a href="{{ url_for('admin.transaction_new') }}" class="btn btn-primary mt-16">Neue Buchung erstellen</a>
</div>
{% endif %}
{% endblock %}
