{% extends "admin/base.html" %}
{% block title %}B√ºndel-Teilabgang - {{ base_name }} - {{ site_settings.business_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>B√ºndel-Teilabgang</h1>
    <a href="{{ url_for('admin.assets') }}" class="btn btn-outline">‚Üê Zur√ºck</a>
</div>

<div class="card">
    <div class="card-header">üì¶ {{ base_name }} ({{ items|length }} Stk. gesamt, {{ active_items|length }} aktiv)</div>

    <form method="POST">
        <div class="card-header">Anlageg√ºter ausw√§hlen</div>
        <p class="text-muted text-sm mb-16">W√§hlen Sie die Anlageg√ºter aus, die abgehen sollen:</p>

        <div class="mb-16" style="display: flex; gap: 8px;">
            <button type="button" class="btn btn-sm btn-outline" onclick="toggleAll(true)">Alle ausw√§hlen</button>
            <button type="button" class="btn btn-sm btn-outline" onclick="toggleAll(false)">Alle abw√§hlen</button>
        </div>

        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px;"></th>
                        <th>Bezeichnung</th>
                        <th style="text-align: right;">Netto (Kauf)</th>
                        <th style="text-align: right;">Buchwert</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for a in items %}
                    <tr class="{{ 'text-muted' if a.disposal_date }}">
                        <td>
                            {% if not a.disposal_date %}
                            <input type="checkbox" name="selected_ids" value="{{ a.id }}" checked
                                   onchange="updateCount()">
                            {% else %}
                            <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </td>
                        <td>{{ a.name }}</td>
                        <td style="text-align: right;">{{ a.purchase_price_net|currency }}</td>
                        <td style="text-align: right;">{{ a._book_value|currency }}</td>
                        <td>
                            {% if a.disposal_date %}
                            <span class="badge badge-danger">Abgegangen ({{ a.disposal_date|date_format }})</span>
                            {% elif a._book_value <= (a.salvage_value or 0) %}
                            <span class="badge badge-warning">Abgeschrieben</span>
                            {% else %}
                            <span class="badge badge-success">Aktiv</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <p class="text-sm mt-10"><strong id="selectedCount">{{ active_items|length }}</strong> ausgew√§hlt</p>

        <hr class="section-divider">
        <div class="card-header">Abgangsdetails</div>

        <div class="form-row">
            <div class="form-group">
                <label for="disposal_date">Abgangsdatum</label>
                <input type="date" id="disposal_date" name="disposal_date" value="{{ today }}" required>
            </div>
            <div class="form-group">
                <label for="disposal_reason">Grund</label>
                <select id="disposal_reason" name="disposal_reason" required>
                    <option value="sold">Verkauft</option>
                    <option value="scrapped">Verschrottet / Entsorgt</option>
                    <option value="private_use">Privatentnahme</option>
                    <option value="other">Sonstiger Abgang</option>
                </select>
            </div>
        </div>

        {% if settings.tax_mode == 'regular' %}
        <div class="form-row">
            <div class="form-group">
                <label for="disposal_tax_treatment">Steuerbehandlung (Verkauf)</label>
                <select id="disposal_tax_treatment" name="disposal_tax_treatment" onchange="updateDisposalTax()">
                    {% for key, label in tax_treatment_labels.items() %}
                    <option value="{{ key }}">
                        {{ label }}{% if key == 'standard' %} ({{ settings.tax_rate }}%){% elif key == 'reduced' %} ({{ settings.tax_rate_reduced }}%){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group" id="disposal_custom_rate_group" style="display: none;">
                <label for="disposal_custom_tax_rate">Steuersatz (%)</label>
                <input type="number" id="disposal_custom_tax_rate" name="disposal_custom_tax_rate" step="0.1" min="0" max="100"
                       placeholder="z.B. 5.0">
            </div>
        </div>
        {% else %}
        <input type="hidden" name="disposal_tax_treatment" value="none">
        {% endif %}

        <div class="form-row">
            <div class="form-group">
                <label>Eingabemodus</label>
                <div class="d-flex gap-10">
                    <label class="radio-label">
                        <input type="radio" name="disposal_input_mode" value="gross" checked onchange="toggleDisposalMode()"> Brutto
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="disposal_input_mode" value="net" onchange="toggleDisposalMode()"> Netto
                    </label>
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group" id="disposal_gross_group">
                <label for="disposal_price_gross">Gesamter Verkaufserl√∂s Brutto (‚Ç¨)</label>
                <input type="number" id="disposal_price_gross" name="disposal_price_gross"
                       step="0.01" min="0" value="0" placeholder="0,00">
                <span class="text-muted text-xs mt-4 d-inline">Gesamtbetrag ‚Äî wird gleichm√§√üig auf die ausgew√§hlten St√ºcke verteilt</span>
            </div>
            <div class="form-group" id="disposal_net_group" style="display: none;">
                <label for="disposal_price">Gesamter Verkaufserl√∂s Netto (‚Ç¨)</label>
                <input type="number" id="disposal_price" name="disposal_price"
                       step="0.01" min="0" value="0" placeholder="0,00">
                <span class="text-muted text-xs mt-4 d-inline">Gesamtbetrag ‚Äî wird gleichm√§√üig auf die ausgew√§hlten St√ºcke verteilt</span>
            </div>
        </div>

        <hr class="section-divider">

        <!-- Optional: Book disposal proceeds to account -->
        <div class="card-header">Kontobuchung</div>
        <div class="form-group">
            <label class="radio-label">
                <input type="checkbox" name="book_inflow" id="book_inflow" value="1" onchange="toggleInflowAccount()">
                Zugang auf Konto buchen
            </label>
            <span class="text-muted text-xs d-inline">Erstellt eine verkn√ºpfte Buchung als Kontozugang (erscheint nicht in der E√úR)</span>
        </div>
        <div class="form-group" id="inflow_account_group" style="display: none;">
            <label for="inflow_account_id">Konto</label>
            <select id="inflow_account_id" name="inflow_account_id">
                {% for acc in accounts %}
                <option value="{{ acc.id }}">{{ acc.name }}</option>
                {% endfor %}
            </select>
        </div>

        <hr class="section-divider">

        <div class="d-flex gap-10">
            <button type="submit" class="btn btn-warning">Abgang erfassen</button>
            <a href="{{ url_for('admin.assets') }}" class="btn btn-outline">Abbrechen</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleInflowAccount() {
    var cb = document.getElementById('book_inflow');
    var grp = document.getElementById('inflow_account_group');
    if (cb && grp) grp.style.display = cb.checked ? '' : 'none';
}

function toggleAll(checked) {
    document.querySelectorAll('input[name="selected_ids"]').forEach(function(cb) {
        cb.checked = checked;
    });
    updateCount();
}

function updateCount() {
    var count = document.querySelectorAll('input[name="selected_ids"]:checked').length;
    document.getElementById('selectedCount').textContent = count;
}

function updateDisposalTax() {
    var sel = document.getElementById('disposal_tax_treatment');
    if (!sel) return;
    var cg = document.getElementById('disposal_custom_rate_group');
    if (cg) cg.style.display = (sel.value === 'custom') ? '' : 'none';
}

function toggleDisposalMode() {
    var mode = document.querySelector('input[name="disposal_input_mode"]:checked').value;
    document.getElementById('disposal_gross_group').style.display = (mode === 'gross') ? '' : 'none';
    document.getElementById('disposal_net_group').style.display = (mode === 'net') ? '' : 'none';
}

updateDisposalTax();
</script>
{% endblock %}
